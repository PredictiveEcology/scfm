---
title: "default maximum fire size by ecozone, era, and ignition source"
author: "Ian Eddy"
date: "13/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this RMD is to provide some default maximum fire estimates for the terrestrial ecozones of Canada. 
They can be used in place of the scfm estimate where appropriate, e.g. when a fire regime area is delineated by administrative
boundaries, rather than ecological ones.  
```{package and directory setup}


library(Require)
Require(c("SpaDES.core", "reproducible", "raster", "data.table", "ggplot2", "LandR", "pemisc"))


paths <- list(inputPath = 'inputs',
              cachePath = 'cache',
              outputPath = 'outputs',
              modulePath = 'modules')

do.call(setPaths, paths)

```

```{repeat runs of scfmRegime}

##generate default objects
studyArea <- prepInputs(url = 'https://sis.agr.gc.ca/cansis/nsdb/ecostrat/zone/ecozone_shp.zip',
                        destinationPath = 'inputs')

studyArea <- spTransform(studyArea, crs('+proj=lcc +lat_0=0 +lon_0=-95 +lat_1=49 +lat_2=77 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs'))

rasterToMatch <- LandR::prepInputsLCC(destinationPath = 'inputs')
rasterToMatch <- Cache(crop, rasterToMatch, studyArea, userTags = c("cropRTM"))
rasterToMatch <- Cache(mask, rasterToMatch, studyArea, userTags = c("maskRTM"))

fireRegimePolys <- studyArea
ecozoneData <- as.data.table(fireRegimePolys@data)
ecozoneData <- ecozoneData[, .(ZONE_NAME = unique(ZONE_NAME)), .(ECOZONE)]

#this function orders the polygs by id.
fireRegimePolys <- rgeos::gUnaryUnion(spgeom = fireRegimePolys, id = fireRegimePolys$ECOZONE)
fireRegimePolys$ECOZONE <- as.numeric(names(fireRegimePolys))
setkey(ecozoneData, ECOZONE)
fireRegimePolys$ZONE_NAME <- ecozoneData$ZONE_NAME
#confirming ecozones have correct id
fireRegimePolys$colour <- c("green", "red", "magenta", "blue", "grey", "purple", "pink", "light blue", "orange",
                            "yellow", "black", "white", "brown", "light yellow", "light green")
fireRegimePolys$PolyID <- as.numeric(fireRegimePolys$ECOZONE)
flammableMap <- Cache(defineFlammable, LandCoverClassifiedMap = rasterToMatch, userTags = c("flammableMap"))

#create runs
modules <- list('scfmLandcoverInit', 'scfmRegime')

L70to2000parameters <- list(
  scfmLandcoverInit = list(
    removeSlivers = FALSE), #no need for slivers with this massive study area - the detect slivers will be very slow anyway
  scfmRegime = list(
    fireCause=c("L"),
    fireEpoch = c(1970, 2000))
)

objects <- list(fireRegimePolys = fireRegimePolys,
                studyArea = studyArea,
                flammableMap = flammableMap,
                vegMap = rasterToMatch,
                rasterToMatch = rasterToMatch)

L70To2000 <- Cache(simInitAndSpades, modules = modules,
                   paths = paths,
                   times = list(start = 1, end = 2),
                   objects = objects,
                   params = L70to2000parameters,
                   userTags = c("L70to2000"))


A70to2000parameters <- L70to2000parameters
A70to2000parameters$scfmRegime$fireCause <- c("L", "H")
A70to2000parameters$scfmRegime$fireEpoch <- c(1970, 2000)


A70To2000 <- Cache(simInitAndSpades,
                   modules = modules,
                   paths = paths,
                   times = list(start = 1, end = 2),
                   objects = objects,
                   params = A70to2000parameters,
                   userTags = c("A70To2000"))

A70To2017parameters <- A70to2000parameters
A70To2017parameters$scfmRegime$fireEpoch <- c(1970, 2017)
A70To2017 <- Cache(simInitAndSpades,
                   modules = modules,
                   paths = paths,
                   times = list(start = 1, end = 2),
                   objects = objects,
                   params = A70To2017parameters,
                   userTags = c("A70To2017"))

L70To2017parameters <- L70to2000parameters
L70To2017parameters$scfmRegime$fireEpoch <- c(1970, 2017)
L70To2017 <- Cache(simInitAndSpades,
                   modules = modules,
                   paths = paths,
                   times = list(start = 1, end = 2),
                   objects = objects,
                   params = L70To2017parameters,
                   userTags = c("L70To2017"))


#define functions for extracting needed objects from simlist
getStat <- function(regime, stat){ return(unlist(lapply(regime, FUN = function(x){x[stat]})))}
buildDT <- function(regime, era, ignitionSource){
  Max <- getStat(regime$scfmRegimePars, stat = "emfs_ha")
  Mean <- getStat(regime$scfmRegimePars, stat = "xBar")
  PEscape <- getStat(regime$scfmRegimePars, stat = "pEscape")
  IgnitionRate <- getStat(regime$scfmRegimePars, stat = "ignitionRate")
  Stats <- data.table(ecozone = names(regime$scfmRegimePars),
                      maxFireSize = Max,
                      meanFireSize = Mean,
                      ignitionRate = IgnitionRate,
                      escapeProb = PEscape,
                      ignitionSource = ignitionSource)
  Stats[, era := era]
  return(Stats)
}

Lightning2000 <- buildDT(L70To2000, ignitionSource = "lightning", era = "1970 to 2000")
All2000 <- buildDT(A70To2000, ignitionSource = "human and lightning", era = "1970 to 2000")
Lightning2017 <- buildDT(L70To2017, ignitionSource = "lightning", era = "1970 to 2017")
All2017 <- buildDT(A70To2017, ignitionSource = "human and lightning", era = "1970 to 2017")


#bind objects for final result
scfmRegimeDefaults <- rbind(Lightning2000, Lightning2017, All2000, All2017)
EcozoneNames <- as.data.table(A70To2000$fireRegimePolys@data)
EcozoneNames[, areaMha := trueArea/100/1e6]
EcozoneNames[, trueArea := NULL]
scfmRegimeDefaults[, ecozone := as.numeric(ecozone)]
scfmRegimeDefaults <- EcozoneNames[scfmRegimeDefaults, on = c("ECOZONE" = 'ecozone')]

```

```{r pressure, echo=FALSE}
#Some plots
firePlot1 <- ggplot(data = scfmRegimeDefaults[era == "1970 to 2017",], aes(y = maxFireSize, x = meanFireSize, col = ZONE_NAME)) +
  geom_point(aes(shape = ignitionSource), size = 3, alpha = 0.6) +
  scale_color_manual(values = pals::glasbey(n = length(unique(scfmRegimeDefaults$ZONE_NAME)))) +
  labs(x = "mean fire size (ha)", y = "max fire size (ha)", title = "1970 to 2017") +
  scale_y_log10() +
  scale_x_log10() +
  guides(col = guide_legend("ecozone"),
         shape = guide_legend("ignition source"))
firePlot1

firePlot2 <- ggplot(data = scfmRegimeDefaults[era == "1970 to 2000",], aes(y = maxFireSize, x = meanFireSize, col = ZONE_NAME)) +
  geom_point(aes(shape = ignitionSource), size = 3, alpha = 0.6) +
  scale_color_manual(values = pals::glasbey(n = length(unique(scfmRegimeDefaults$ZONE_NAME)))) +
  labs(x = "mean fire size (ha)", y = "max fire size (ha)", title = "1970 to 2000") +
  scale_y_log10() +
  scale_x_log10() +
  guides(col = guide_legend("ecozone"),
         shape = guide_legend("ignition source"))
firePlot2


firePlot3 <- ggplot(data = scfmRegimeDefaults[era == "1970 to 2017"], aes(y = ignitionRate, x = meanFireSize, col = ZONE_NAME)) +
  geom_point(aes(shape = ignitionSource), size = 3, alpha = 0.6) +
  scale_color_manual(values = pals::glasbey(n = length(unique(scfmRegimeDefaults$ZONE_NAME)))) +
  labs(x = "mean fire size (ha)", y = "ignition rate", title = "1970 to 2017") +
  scale_y_log10() +
  scale_x_log10() +
  guides(col = guide_legend("ecozone"),
         shape = guide_legend("ignition source"))
firePlot3


firePlot4 <- ggplot(data = scfmRegimeDefaults[era == "1970 to 2000"], aes(y = ignitionRate, x = meanFireSize, col = ZONE_NAME)) +
  geom_point(aes(shape = ignitionSource), size = 3, alpha = 0.6) +
  scale_color_manual(values = pals::glasbey(n = length(unique(scfmRegimeDefaults$ZONE_NAME)))) +
  labs(x = "mean fire size (ha)", y = "ignition rate", title = "1970 to 2000") +
  scale_y_log10() +
  scale_x_log10() +
  guides(col = guide_legend("ecozone"),
         shape = guide_legend("ignition source"))
firePlot4


# ggsave(firePlot1, filename = "outputs/mean_x_MaxFire_by_Ecozone1970_2017.png", device = "png")
# ggsave(firePlot2, filename = "outputs/mean_x_MaxFire_by_Ecozone1970_2000.png", device = "png")
# ggsave(firePlot3, filename = "outputs/MFS_x_Ignition_by_Ecozone1970_2017.png", device = "png")
# ggsave(firePlot4, filename = "outputs/MFS_x_Ignition_by_Ecozone1970_2000.png", device = "png")
# 
# saveRDS(scfmRegimeDefaults, "inputs/scfmRegimeDefaults_250mRes.rds")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
